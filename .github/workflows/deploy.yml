name: Deploy reportly-api

on:
  push:
    branches: [ main ]

jobs:
  build:
    name: reportly-api build & deploy
    runs-on: ubuntu-latest
    timeout-minutes: 30
    env:
      APP_NAME: reportly-api   # <- 원하는 이름

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build with Gradle
        run: ./gradlew clean build -x test

      - name: Upload JAR to server
        uses: appleboy/scp-action@v1
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          source: "build/libs/*.jar"
          target: "/home/${{ secrets.SERVER_USER }}/app/"
          strip_components: 2
          overwrite: true

      - name: Stop existing app (if any)
        uses: appleboy/ssh-action@v1
        env:
          APP_NAME: ${{ env.APP_NAME }}    # 원격에 전달할 값
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.Server_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          envs: APP_NAME                   # <- 이 키를 원격에 전달
          command_timeout: 15m
          script: |
            bash -lc '
              set -Eeuo pipefail

              # 기본값(전달 안 되더라도 대비)
              APP_NAME="${APP_NAME:-reportly-api}"

              APP_DIR="/home/${{ secrets.SERVER_USER }}/app"
              JAR_NAME="${APP_NAME}.jar"

              mkdir -p "$APP_DIR"

              PIDS="$(pgrep -f "java .*${JAR_NAME}" || true)"
              if [ -z "$PIDS" ]; then
                echo "실행 중인 프로세스 없음."
                exit 0
              fi

              echo "기존 프로세스 종료 중..."
              kill $PIDS || true

              for i in $(seq 1 15); do
                if ! pgrep -f "java .*${JAR_NAME}" >/dev/null 2>&1; then
                  break
                fi
                sleep 1
              done

              if pgrep -f "java .*${JAR_NAME}" >/dev/null 2>&1; then
                echo "강제 종료(SIGKILL) 시도..."
                kill -9 $PIDS || true
              fi

              echo "정지 완료"
            '

      - name: Start app and health check
        uses: appleboy/ssh-action@v1
        env:
          APP_NAME: ${{ env.APP_NAME }}
          DB_CONFIG_JSON: ${{ secrets.DB_CONFIG_JSON }}
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          envs: APP_NAME,DB_CONFIG_JSON
          command_timeout: 15m
          script: |
            bash -lc '
              set -Eeuo pipefail

              APP_NAME="${APP_NAME:-reportly-api}"

              APP_DIR="/home/${{ secrets.SERVER_USER }}/app"
              JAR_NAME="${APP_NAME}.jar"
              PID_FILE="$APP_DIR/${JAR_NAME}.pid"
              LOG_FILE="$APP_DIR/app.log"

              mkdir -p "$APP_DIR"

              LATEST_JAR=$(ls -t "$APP_DIR"/*.jar 2>/dev/null | head -n1 || true)
              if [ -z "$LATEST_JAR" ]; then
                echo "❌ JAR 파일을 찾을 수 없습니다: $APP_DIR"
                exit 1
              fi
              cp -f "$LATEST_JAR" "$APP_DIR/$JAR_NAME"

              echo "애플리케이션 시작..."
              nohup java -jar "$APP_DIR/$JAR_NAME" --spring.profiles.active=prod > "$LOG_FILE" 2>&1 &
              echo $! > "$PID_FILE"

              echo "헬스체크 시작..."
              for i in $(seq 1 10); do
                if curl -fsS "https://h-infinite-power.store/${APP_NAME}/health" >/dev/null; then
                  echo "✅ 애플리케이션이 정상적으로 시작되었습니다."
                  exit 0
                fi
                echo "헬스체크 실패, 재시도 중... ($i/10)"
                sleep 10
              done

              echo "❌ 애플리케이션 시작 실패"
              echo "---- last 200 lines of app.log ----"
              tail -n 200 "$LOG_FILE" || true
              exit 1
            '

      - name: Print server logs on failure
        if: failure()
        uses: appleboy/ssh-action@v1
        env:
          APP_NAME: ${{ env.APP_NAME }}
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          envs: APP_NAME
          script: |
            bash -lc '
              APP_NAME="${APP_NAME:-reportly-api}"
              LOG_FILE="/home/${{ secrets.SERVER_USER }}/app/app.log"
              echo "---- last 400 lines of app.log ----"
              tail -n 400 "$LOG_FILE" || echo "log file not found"
            '
